import{r as e,h as r,d as t,g as i,A as o,s}from"./index-BX7dOzwF.js";import{i as a}from"./i18n-vendor-CvzjU6Pd.js";import{c as n}from"./utils-vendor-euKWYQ_X.js";const l={recipientName:"",occasion:"",relationship:"",senderName:"",hobbies:"",qualities:"",uniqueTraits:"",memories:"",emotionalTone:"",genre:"",mood:"",tempo:"",duration:"",lyrics:"",songTitle:"",emotion:"",vocalPreference:""},c={formData:l,currentStep:0,isPreviewLoading:!1,isLoading:!1,error:null,generatedAudioUrl:null,generatedLyrics:null,audioClips:[],currentTaskId:null,isPolling:!1,musicGenerationStatus:"idle",completedClips:0,totalExpected:2,pollingInterval:null,isMvpFlowComplete:!1,isValidationPopupVisible:!1},u=()=>"en"===a.language?"en-US":"pt-BR",d=(e,r)=>s(e,"en"===a.language?"en":"pt",r),p=n()(e((e,s)=>({...c,updateFormData:r=>{e(e=>({formData:{...e.formData,...r}}))},setCurrentStep:r=>{e({currentStep:r})},setPreviewLoading:r=>{e({isPreviewLoading:r})},setLoading:r=>{e({isLoading:r})},setError:r=>{e({error:r})},clearError:()=>{e({error:null})},nextStep:()=>{e(e=>({currentStep:e.currentStep+1}))},prevStep:()=>{e(e=>({currentStep:Math.max(0,e.currentStep-1)}))},generateLyrics:async()=>{var r,n;const{formData:l}=s();if(!l.recipientName||!l.occasion||!l.relationship){const r=a.t("validation.fillRequiredFieldsStep1",{ns:"musicStore"});return e({error:r}),void i.error(r)}const c={...l,lyricsOnly:!0,language:u()};e({isLoading:!0,error:null});try{const s=await t(o.GENERATE_PREVIEW,{method:"POST",body:c});if(s.success&&(null==(r=s.data)?void 0:r.lyrics)&&(null==(n=s.data)?void 0:n.songTitle))e(e=>({formData:{...e.formData,lyrics:s.data.lyrics,songTitle:s.data.songTitle},generatedLyrics:s.data.lyrics})),i.success(a.t("success.lyricsGenerated",{ns:"musicStore"}));else{const r=a.t("errors.invalidApiResponse",{ns:"musicStore"});e({error:r}),i.error(r)}}catch(d){const r=d instanceof Error?d.message:a.t("errors.connectionError",{ns:"musicStore"});e({error:r}),i.error(r)}finally{e({isLoading:!1})}},generatePreview:async()=>{const{formData:r}=s();if(!(r.songTitle&&r.recipientName&&r.occasion&&r.relationship&&r.emotionalTone&&r.genre&&r.mood&&r.tempo&&r.duration)){const r=a.t("validation.fillRequiredFields",{ns:"musicStore"});return e({error:r}),void i.error(r)}const n={...r,lyricsOnly:!1,language:u()};e({isPreviewLoading:!0,error:null});try{const s=await t(o.GENERATE_PREVIEW,{method:"POST",body:n});if(s.success&&s.data)e({generatedAudioUrl:s.data.audioUrl,generatedLyrics:s.data.lyrics,formData:{...r,lyrics:s.data.lyrics},isPreviewLoading:!1});else{const r=s.error||a.t("errors.unknownPreviewError",{ns:"musicStore"});e({error:r,isPreviewLoading:!1}),i.error(r)}}catch(l){const r=a.t("errors.connectionError",{ns:"musicStore"});e({error:r,isPreviewLoading:!1}),i.error(r)}},regenerateLyrics:e=>{(async()=>{await s().generateLyrics(),e&&e()})()},generateMusic:async()=>{var r,n;const{formData:l}=s();if(!(l.lyrics&&l.songTitle&&l.genre&&l.emotion&&l.vocalPreference)){const r=a.t("validation.fillStyleFields",{ns:"musicStore"});return e({error:r}),void i.error(r)}const c={...l,lyricsOnly:!1,language:u()};e({isPreviewLoading:!0,isLoading:!0,error:null,audioClips:[],musicGenerationStatus:"processing",completedClips:0,currentTaskId:null});try{const u=await t(o.GENERATE_PREVIEW,{method:"POST",body:c});if(u.success&&u.taskId){const r=u.totalExpected||u.expectedClips||2,t=Array(r).fill(null).map((e,r)=>({id:`skeleton-${r}`,status:"processing"}));e({currentTaskId:u.taskId,totalExpected:r,audioClips:t,musicGenerationStatus:"processing"}),s().startPolling(),i.success(a.t("success.musicGenerationStarted",{ns:"musicStore"}))}else if(u.success&&u.audioClips)e({audioClips:u.audioClips,generatedAudioUrl:null==(r=u.audioClips[0])?void 0:r.audio_url,generatedLyrics:(null==(n=u.data)?void 0:n.lyrics)||l.lyrics,isPreviewLoading:!1,isLoading:!1,musicGenerationStatus:"completed",completedClips:u.audioClips.length}),i.success(a.t("success.musicGenerated",{ns:"musicStore",count:u.audioClips.length}));else{const r=u.error||"Resposta da API invÃ¡lida";e({error:r,isPreviewLoading:!1,isLoading:!1,musicGenerationStatus:"failed"}),i.error(r)}}catch(d){const r=d,t=r.status,o=r.data;if(402===t&&"PAYMENT_REQUIRED"===(null==o?void 0:o.error)){const r=a.t("errors.paymentRequired",{ns:"musicStore"});return e({error:r,isPreviewLoading:!1,isLoading:!1,musicGenerationStatus:"failed"}),void i.error(r)}const s=a.t("errors.generateMusicCatch",{ns:"musicStore"});e({error:s,isPreviewLoading:!1,isLoading:!1,musicGenerationStatus:"failed"}),i.error(s)}},checkMusicStatus:async()=>{const{currentTaskId:r}=s();if(r)try{const n=await t(`${o.CHECK_MUSIC_STATUS}/${r}`,{method:"GET"});if(!n.success||"object"!=typeof n.data)return;const l=n.data,c=l.completedClips||0,u=l.totalExpected||s().totalExpected||0,d=Array.isArray(l.audioClips)?l.audioClips:[];e({audioClips:d,completedClips:c}),u>0&&c>=u&&(e({isLoading:!1,isPreviewLoading:!1,isPolling:!1,musicGenerationStatus:"completed",currentTaskId:null}),s().stopPolling(),i.success(a.t("success.allMusicGenerated",{ns:"musicStore"})))}catch(n){s().stopPolling(),e({isPolling:!1,musicGenerationStatus:"error",isLoading:!1});const r=n instanceof Error?n.message:a.t("errors.unknownError",{ns:"musicStore"});e({error:r}),i.error(r)}},startPolling:()=>{const{currentTaskId:r}=s();if(s().stopPolling(),!r)return;const t=setInterval(async()=>{await s().checkMusicStatus()},7e3);e({pollingInterval:t})},stopPolling:()=>{const{pollingInterval:r}=s();r&&(clearInterval(r),e({pollingInterval:null}))},setMvpFlowComplete:r=>{e({isMvpFlowComplete:r})},setValidationPopupVisible:r=>{e({isValidationPopupVisible:r})},completeMvpFlow:()=>{e({isMvpFlowComplete:!0,isValidationPopupVisible:!1})},startNewCreationFlow:async(e,o)=>{var s;const n=p.getState(),l=r.getState();n.reset();try{const r=await t("/api/user/creation-status",{method:"GET"});!0===(r.isFree||(null==(s=r.data)?void 0:s.isFree))?(l.unblockCreationFlow(),e(d("create"))):(l.blockCreationFlow(),l.showPaymentPopup())}catch(c){l.unblockCreationFlow(),i.info(a.t("errors.statusCheckFailedAccessing",{ns:"musicStore"})),e(d("create"))}},resetForm:()=>{e({formData:l,currentStep:0,error:null})},resetFlow:()=>{s().stopPolling(),e({formData:l,currentStep:0,isPreviewLoading:!1,isLoading:!1,error:null,generatedAudioUrl:null,generatedLyrics:null,audioClips:[],currentTaskId:null,isPolling:!1,musicGenerationStatus:"idle",completedClips:0,totalExpected:2,pollingInterval:null,isMvpFlowComplete:!1,isValidationPopupVisible:!1})},reset:()=>{s().stopPolling(),e(c)}}),{name:"music-generation-storage",partialize:e=>({formData:e.formData,currentStep:e.currentStep,generatedAudioUrl:e.generatedAudioUrl,generatedLyrics:e.generatedLyrics,audioClips:e.audioClips,musicGenerationStatus:e.musicGenerationStatus,completedClips:e.completedClips,totalExpected:e.totalExpected,isMvpFlowComplete:e.isMvpFlowComplete})}));export{p as u};
